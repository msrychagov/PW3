//
//  WishCalendarViewController.swift
//  msrychagovPW2
//
//  Created by –ú–∏—Ö–∞–∏–ª –†—ã—á–∞–≥–æ–≤ on 09.12.2024.
//


import UIKit

class WishCalendarViewController: UIViewController{
    
    
    
    //MARK: - Constants
    private enum Contants {
        
    }
    
    //MARK: - Variables
    private var wishEvents: [WishEventModel] = []
    private let addButton: UIButton = UIButton(type: .system)
    private let defaults = UserDefaults.standard
    private let collectionView: UICollectionView = UICollectionView(
        frame: .zero,
        collectionViewLayout: UICollectionViewFlowLayout()
    )
    var cellTextColor: UIColor? {
        didSet {
            addButton.setTitleColor(cellTextColor, for: .normal)
        }
    }
    
    var cellColor: UIColor? {
        didSet {
            addButton.backgroundColor = cellColor
        }
    }
    
    //MARK: - Methods
    override func viewDidLoad() {
        super.viewDidLoad()
        loadEvents()
        configureUI()
        if let layout = collectionView.collectionViewLayout as?
            UICollectionViewFlowLayout {
            layout.minimumInteritemSpacing = 0
            layout.minimumLineSpacing = 0
            layout.invalidateLayout()
        }
        /* Temporary line */
        collectionView.register(
            WishEventCell.self,
            forCellWithReuseIdentifier: WishEventCell.reuseIdentifier
        )
    }
    
    private func openCreateWishScreen() {
        let vc = AddWishEventViewController() // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω
        vc.view.backgroundColor = view.backgroundColor
        vc.textColor = cellTextColor
        vc.tableColor = cellColor
        vc.onAddWish = { [weak self] newWish in
            guard let self = self else { return }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ —Å–ø–∏—Å–æ–∫
            self.wishEvents.append(newWish)
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            self.saveEvents()
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é
            self.collectionView.reloadData()
        }
        
        present(vc, animated: true) // –û—Ç–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
    }
    
    private func openWishListScreen() {
        let wishListVC = WishStoringViewController() // –≠–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
        
        wishListVC.view.backgroundColor = self.view.backgroundColor // ‚úÖ –ü–µ—Ä–µ–¥–∞—ë–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
        wishListVC.cellBackgroundColor = cellColor!
        wishListVC.wishLabelTextColor = cellTextColor!
        wishListVC.onWishSelected = { [weak self] selectedWish in
            self?.navigationController?.popViewController(animated: true) // üîô –ó–∞–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
            self?.addWishFromList(selectedWish) // ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
        }
        
        navigationController?.pushViewController(wishListVC, animated: true) // ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞
    }
    
    private func addWishFromList(_ wish: String) {
        let vc = AddWishEventViewController()
        vc.view.backgroundColor = view.backgroundColor
        vc.textColor = cellTextColor
        vc.tableColor = cellColor
        vc.setWishTitle(wish) // ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        
        vc.onAddWish = { [weak self] newWish in
            guard let self = self else { return }
            self.wishEvents.append(newWish)
            self.saveEvents()
            self.collectionView.reloadData()
        }
        
        present(vc, animated: true)
    }
    
    private func editWish(_ wish: WishEventModel, at indexPath: Int) {
        let vc = AddWishEventViewController()
        vc.view.backgroundColor = view.backgroundColor
        vc.textColor = cellTextColor
        vc.tableColor = cellColor
        vc.setWishTitle(wish.title)
        vc.setWishDescription(wish.description)
        vc.setWishStartDate(wish.startDate)
        vc.setWishEndDate(wish.endDate)
        vc.onAddWish = { [weak self] newWish in
            guard let self = self else { return }
            self.wishEvents[indexPath] = newWish
            self.saveEvents()
            self.collectionView.reloadData()
        }
        present(vc, animated: true)
    }
    
    private func shareWish(_ wish: WishEventModel) {
        let activityViewController = UIActivityViewController(activityItems: [wish.title], applicationActivities: nil)
        present(activityViewController, animated: true)
    }
    
    //MARK: - Configures
    private func configureUI() {
        view.addSubview(collectionView)
        view.addSubview(addButton)
        configureCollection()
        configureAddButton()
    }
    private func configureAddButton() {
        addButton.translatesAutoresizingMaskIntoConstraints = false
        addButton.setTitle("–î–æ–±–∞–≤–∏—Ç—å", for: .normal)
        addButton.titleLabel?.font = .systemFont(ofSize: 32, weight: .bold)
        addButton.layer.cornerRadius = 20
        addButton.pinBottom(to: view.safeAreaLayoutGuide.bottomAnchor, 3)
        addButton.pinCenterX(to: view.centerXAnchor)
        addButton.setWidth(250)
        addButton.setHeight(80)
        addButton.addTarget(self, action: #selector(addButtonTapped), for: .touchUpInside)
        
    }
    private func configureCollection() {
        collectionView.translatesAutoresizingMaskIntoConstraints = false
        collectionView.delegate = self
        collectionView.dataSource = self
        collectionView.backgroundColor = .clear
        collectionView.alwaysBounceVertical = true
        collectionView.showsVerticalScrollIndicator = false
        collectionView.contentInset = UIEdgeInsets(top: 10, left: 10, bottom: 10, right: 10)
        collectionView.layer.cornerRadius = 10
        /* Temporary line */
        collectionView.register(UICollectionViewCell.self, forCellWithReuseIdentifier: "cell")
        collectionView.pinHorizontal(to: view, 20)
        collectionView.pinBottom(to: addButton.topAnchor, 30)
        collectionView.pinTop(to: view.safeAreaLayoutGuide.topAnchor, 10)
    }
    
    private func saveEvents() {
        if let encodedData = try? JSONEncoder().encode(wishEvents) {
            defaults.set(encodedData, forKey: "Events")
        }
    }
    
    private func loadEvents() {
        if let savedData = defaults.data(forKey: "Events"),
           let decodedEvents = try? JSONDecoder().decode([WishEventModel].self, from: savedData) {
            wishEvents = decodedEvents
        }
    }
    
    //MARK: - Actions
    @objc func addButtonTapped() {
        let alertController = UIAlertController(
            title: "–î–æ–±–∞–≤–∏—Ç—å –∂–µ–ª–∞–Ω–∏–µ",
            message: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–ª–µ–Ω–∏—è",
            preferredStyle: .actionSheet
        )
        
        let createNewAction = UIAlertAction(title: "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ", style: .default) { _ in
            self.openCreateWishScreen()
        }
        
        let chooseExistingAction = UIAlertAction(title: "–í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞", style: .default) { _ in
            self.openWishListScreen()
        }
        
        let cancelAction = UIAlertAction(title: "–û—Ç–º–µ–Ω–∞", style: .cancel, handler: nil)
        
        alertController.addAction(createNewAction)
        alertController.addAction(chooseExistingAction)
        alertController.addAction(cancelAction)
        
        present(alertController, animated: true)
    }
}

// MARK: - UICollectionViewDataSource
extension WishCalendarViewController: UICollectionViewDataSource {
    func collectionView(
        _
        collectionView: UICollectionView,
        numberOfItemsInSection section: Int
    ) -> Int {
        return wishEvents.count
    }
    func collectionView(
        _
        collectionView: UICollectionView,
        cellForItemAt indexPath: IndexPath
    ) -> UICollectionViewCell {
        let cell = collectionView.dequeueReusableCell(
            withReuseIdentifier: WishEventCell.reuseIdentifier,
            for: indexPath
        )
        guard let wishEventCell = cell as? WishEventCell else {
            return cell
        }
        wishEventCell.onDelete = { [weak self] in
            guard let self = self else { return }
            let model = self.wishEvents[indexPath.item]
            
            if let eventIdentifier = model.eventIdentifier, !eventIdentifier.isEmpty {
                print("–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º: \(eventIdentifier)")
                let calendarManager = CalendarManager()
                calendarManager.delete(eventIdentifier: eventIdentifier) { success in
                    if success {
                        print("–°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.")
                    } else {
                        print("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.")
                    }
                }
            } else {
                print("–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–±—ã—Ç–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç.")
            }
            
            self.wishEvents.remove(at: indexPath.item)
            self.collectionView.reloadData()
            self.saveEvents()
        }
        
        wishEventCell.onEdit = { [weak self] in
            guard let self = self else { return }
            self.editWish(self.wishEvents[indexPath.row], at: indexPath.row)
        }
        
        wishEventCell.onShare = { [weak self] in
            guard let self = self else { return }
            let model = self.wishEvents[indexPath.item]
            let activityViewController = UIActivityViewController(
                activityItems: [model.title],
                applicationActivities: nil
            )
            self.present(activityViewController, animated: true)
        }
        // –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        let model = wishEvents[indexPath.item]
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º —è—á–µ–π–∫—É
        wishEventCell.configure(with: model, wrapColor: cellColor, text: cellTextColor)
        
        return wishEventCell
    }
}


// MARK: - UICollectionViewDelegateFlowLayout
extension WishCalendarViewController: UICollectionViewDelegateFlowLayout {
    func collectionView(
        _
        collectionView: UICollectionView,
        layout collectionViewLayout: UICollectionViewLayout,
        sizeForItemAt indexPath: IndexPath
    ) -> CGSize {
        // Adjust cell size as needed
        return CGSize(width: collectionView.bounds.width - 10, height: 200)
    }
    func collectionView(
        _
        collectionView: UICollectionView,
        didSelectItemAt indexPath: IndexPath
    ) {
        print("Cell tapped at index \(indexPath.item)")
    }
}
